[TOC]



# **用户注册要点**：

## 逻辑框架

![1564237318545](assets\1564237318545.png)

## 前端-异步判断输入是否合法

```
	<script>
        /*
            表单校验：
                1.用户名：单词字符，长度8到20位
                2.密码：单词字符，长度8到20位
                3.email：邮件格式
                4.姓名：非空
                5.手机号：手机号格式
                6.出生日期：非空
                7.验证码：非空
         */

        //校验用户名
        //单词字符，长度8到20位
        function checkUsername() {
            //1.获取用户名值
            var username = $("#username").val();
            //2.定义正则
            var reg_username = /^\w{8,20}$/;

            //3.判断，给出提示信息
            var flag = reg_username.test(username);
            if(flag){
                //用户名合法
                $("#username").css("border","");
            }else{
                //用户名非法,加一个红色边框
                $("#username").css("border","1px solid red");
            }

            return flag;
        }

        //校验密码
        function checkPassword() {
            //1.获取密码值
            var password = $("#password").val();
            //2.定义正则
            var reg_password = /^\w{8,20}$/;

            //3.判断，给出提示信息
            var flag = reg_password.test(password);
            if(flag){
                //密码合法
                $("#password").css("border","");
            }else{
                //密码非法,加一个红色边框
                $("#password").css("border","1px solid red");
            }

            return flag;
        }

        //校验邮箱
        function checkEmail(){
            //1.获取邮箱
            var email = $("#email").val();
            //2.定义正则        itcast@163.com
            var reg_email = /^\w+@\w+\.\w+$/;

            //3.判断
            var flag = reg_email.test(email);
            if(flag){
                $("#email").css("border","");
            }else{
                $("#email").css("border","1px solid red");
            }

            return flag;
        }

        $(function () {
            //当表单提交时，调用所有的校验方法
            $("#registerForm").submit(function(){
                //1.发送数据到服务器
                if(checkUsername() && checkPassword() && checkEmail()){
                    //校验通过,发送ajax请求，提交表单的数据   username=zhangsan&password=123

                    $.post("registUserServlet",$(this).serialize(),function(data){
                        //处理服务器响应的数据  data  {flag:true,errorMsg:"注册失败"}

                        if(data.flag){
                            //注册成功，跳转成功页面
                location.href="register_ok.html";
            }else{
                //注册失败,给errorMsg添加提示信息
                $("#errorMsg").html(data.errorMsg);

            }
        });

        }
                //2.不让页面跳转
                return false;
                //如果这个方法没有返回值，或者返回为true，则表单提交，如果返回为false，则表单不提交
            });

            //当某一个组件失去焦点是，调用对应的校验方法
            $("#username").blur(checkUsername);
            $("#password").blur(checkPassword);
            $("#email").blur(checkEmail);


        });


    </script>
```



## 工具类-生成唯一激活码用于邮箱激活

    /**
     * 产生UUID随机字符串工具类
     */
    public final class UuidUtil {
        private UuidUtil(){}
        public static String getUuid(){
            return UUID.randomUUID().toString().replace("-","");
        }
## Service层-注册用户控制层

        /**
         * 注册用户
         * @param user
         * @return
         */
        @Override
        public boolean regist(User user) {
            //1.根据用户名查询用户对象
            User u = userDao.findByUsername(user.getUsername());
            //判断u是否为null
            if(u != null){
                //用户名存在，注册失败
                return false;
            }
            //2.保存用户信息
            //2.1设置激活码，唯一字符串
            user.setCode(UuidUtil.getUuid());
            //2.2设置激活状态
            user.setStatus("N");
            userDao.save(user);
    
            //3.激活邮件发送，邮件正文？
    
            String content="<a href='http://localhost/travel/activeUserServlet?code="+user.getCode()+"'>点击激活【黑马旅游网】</a>";
    
            MailUtils.sendMail(user.getEmail(),content,"激活邮件");
    
            return true;
        }
## Servlet-获取前端传来的消息并完成注册

    @WebServlet("/registUserServlet")
    public class RegistUserServlet extends HttpServlet {
        protected void doPost(HttpServletRequest request, HttpServletResponse response)     throws ServletException, IOException {
        
            //验证校验
            String check = request.getParameter("check");
            //从sesion中获取验证码
            HttpSession session = request.getSession();
            String checkcode_server = (String) session.getAttribute("CHECKCODE_SERVER");
            session.removeAttribute("CHECKCODE_SERVER");//为了保证验证码只能使用一次
            //比较
            if(checkcode_server == null || !checkcode_server.equalsIgnoreCase(check)){
                //验证码错误
                ResultInfo info = new ResultInfo();
                //注册失败
                info.setFlag(false);
                info.setErrorMsg("验证码错误");
                //将info对象序列化为json
                ObjectMapper mapper = new ObjectMapper();
                String json = mapper.writeValueAsString(info);
                response.setContentType("application/json;charset=utf-8");
                response.getWriter().write(json);
                return;
            }
    
            //1.获取数据
            Map<String, String[]> map = request.getParameterMap();
    
            //2.封装对象
            User user = new User();
            try {
                BeanUtils.populate(user,map);
            } catch (IllegalAccessException e) {
                e.printStackTrace();
            } catch (InvocationTargetException e) {
                e.printStackTrace();
            }
    
            //3.调用service完成注册
            UserService service = new UserServiceImpl();
            boolean flag = service.regist(user);
            ResultInfo info = new ResultInfo();
            //4.响应结果
            if(flag){
                //注册成功
                info.setFlag(true);
            }else{
                //注册失败
                info.setFlag(false);
                info.setErrorMsg("注册失败!");
            }
    
            //将info对象序列化为json
            ObjectMapper mapper = new ObjectMapper();
            String json = mapper.writeValueAsString(info);
    
            //将json数据写回客户端
            //设置content-type
            response.setContentType("application/json;charset=utf-8");
            response.getWriter().write(json);
        }
## 工具类-向注册邮件发送验证信息

    /**
     * 发邮件工具类
     */
    public final class MailUtils {
        private static final String USER = ""; // 发件人称号，同邮箱地址
        private static final String PASSWORD = ""; // 如果是qq邮箱可以使户端授权码，或者登录密码
    
        /**
         *
         * @param to 收件人邮箱
         * @param text 邮件正文
         * @param title 标题
         */
        /* 发送验证信息的邮件 */
    
        public static boolean sendMail(String to, String text, String title){
            try {
                final Properties props = new Properties();
                props.put("mail.smtp.auth", "true");
                props.put("mail.smtp.host", "smtp.qq.com");
    
                // 发件人的账号
                props.put("mail.user", USER);
                //发件人的密码
                props.put("mail.password", PASSWORD);
    
                // 构建授权信息，用于进行SMTP进行身份验证
                Authenticator authenticator = new Authenticator() {
                    @Override
                    protected PasswordAuthentication getPasswordAuthentication() {
                        // 用户名、密码
                        String userName = props.getProperty("mail.user");
                        String password = props.getProperty("mail.password");
                        return new PasswordAuthentication(userName, password);
                    }
                };
                // 使用环境属性和授权信息，创建邮件会话
                Session mailSession = Session.getInstance(props, authenticator);
                // 创建邮件消息
                MimeMessage message = new MimeMessage(mailSession);
                // 设置发件人
                String username = props.getProperty("mail.user");
                InternetAddress form = new InternetAddress(username);
                message.setFrom(form);
    
                // 设置收件人
                InternetAddress toAddress = new InternetAddress(to);
                message.setRecipient(Message.RecipientType.TO, toAddress);
    
                // 设置邮件标题
                message.setSubject(title);
    
                // 设置邮件的内容体
                message.setContent(text, "text/html;charset=UTF-8");
                // 发送邮件
                Transport.send(message);
                return true;
            }catch (Exception e){
                e.printStackTrace();
            }
            return false;
        }
## Service层-激活用户改变激活状态

    /**
     * 激活用户
     * @param code
     * @return
     */
    @Override
    public boolean active(String code) {
        //1.根据激活码查询用户对象
        User user = userDao.findByCode(code);
        if(user != null){
            //2.调用dao的修改激活状态的方法
            userDao.updateStatus(user);
            return true;
        }else{
            return false;
        }
## Dao层-更新激活状态

    /**
     * 修改指定用户激活状态
     * @param user
     */
    @Override
    public void updateStatus(User user) {
        String sql = " update tab_user set status = 'Y' where uid=?";
        template.update(sql,user.getUid());
    }

## Servlet-返回激活结果

    @WebServlet("/activeUserServlet")
    public class ActiveUserServlet extends HttpServlet {
        protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            //1.获取激活码
            String code = request.getParameter("code");
            if(code != null){
                //2.调用service完成激活
                UserService service = new UserServiceImpl();
                boolean flag = service.active(code);
    
                //3.判断标记
                String msg = null;
                if(flag){
                    //激活成功
                    msg = "激活成功，请<a href='login.html'>登录</a>";
                }else{
                    //激活失败
                    msg = "激活失败，请联系管理员!";
                }
                response.setContentType("text/html;charset=utf-8");
                response.getWriter().write(msg);
            }
    
        }
    
        protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            this.doPost(request, response);
        }
    }








# 用户登录要点：

## 逻辑框架

![1564237261110](assets\1564237261110.png)

什么叫做登录和退出？

> session中有user对象则为登录，没有则为退出。

退出的实现步骤：

> 1、访问servlet，将session销毁
>
> 2、跳转到登录页面

## Servlet-登录功能

    @WebServlet("/loginServlet")
    public class LoginServlet extends HttpServlet {
        protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            //1.获取用户名和密码数据
            Map<String, String[]> map = request.getParameterMap();
            //2.封装User对象
            User user = new User();
            try {
                BeanUtils.populate(user,map);
            } catch (IllegalAccessException e) {
                e.printStackTrace();
            } catch (InvocationTargetException e) {
                e.printStackTrace();
            }
    
            //3.调用Service查询
            UserService service = new UserServiceImpl();
            User u  = service.login(user);
    
            ResultInfo info = new ResultInfo();
    
            //4.判断用户对象是否为null
            if(u == null){
                //用户名密码或错误
                info.setFlag(false);
                info.setErrorMsg("用户名密码或错误");
            }
            //5.判断用户是否激活
            if(u != null && !"Y".equals(u.getStatus())){
                //用户尚未激活
                info.setFlag(false);
                info.setErrorMsg("您尚未激活，请激活");
            }
            //6.判断登录成功
            if(u != null && "Y".equals(u.getStatus())){
                request.getSession().setAttribute("user",u);//登录成功标记
    
                //登录成功
                info.setFlag(true);
            }
    
            //响应数据
            ObjectMapper mapper = new ObjectMapper();
    
            response.setContentType("application/json;charset=utf-8");
            mapper.writeValue(response.getOutputStream(),info);
    
        }
    
        protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            this.doPost(request, response);
        }
    }


## Servlet-退出功能

    @WebServlet("/exitServlet")
    public class ExitServlet extends HttpServlet {
        protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            //1.销毁session
            request.getSession().invalidate();
    
            //2.跳转登录页面
            response.sendRedirect(request.getContextPath()+"/login.html");
        }
    
        protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            this.doPost(request, response);
        }
    }




# 优化Servlet

## 逻辑框架

**意义**：减少Servlet的数量，让项目结构看起来更简洁

**核心方法**：利用反射机制抽取各个Servlet中的方法

![1564245858583](assets\1564245858583.png)



    public class BaseServlet extends HttpServlet {
    
        @Override
        protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        
            //System.out.println("baseServlet的service方法被执行了...");
    
            //完成方法分发
            //1.获取请求路径
            String uri = req.getRequestURI(); //   /travel/user/add
            System.out.println("请求uri:"+uri);//  /travel/user/add
            
            //2.获取方法名称
            String methodName = uri.substring(uri.lastIndexOf('/') + 1);
            System.out.println("方法名称："+methodName);
            
            //3.获取方法对象Method
            //谁调用我？我代表谁
            System.out.println(this);
            //UserServlet的对象cn.itcast.travel.web.servlet.UserServlet@4903d97e
            try {
                //获取方法
                Method method = this.getClass().getMethod(methodName, HttpServletRequest.class, HttpServletResponse.class);
                
            //4.执行方法
            //暴力反射
          //method.setAccessible(true);
            method.invoke(this,req,resp);
            } catch (NoSuchMethodException e) {
                e.printStackTrace();
            } catch (IllegalAccessException e) {
                e.printStackTrace();
            } catch (InvocationTargetException e) {
                e.printStackTrace();
            }
        }

​    UserServlet继承BaseServlet，在同一个模块下将所有功能放入同一个Servlet（同时将html中的路径修改为/user/....）

    @WebServlet("/user/*") // /user/add /user/find
    public class UserServlet extends BaseServlet {
    
        //声明UserService业务对象
        private UserService service = new UserServiceImpl();
    
        /**
         * 注册功能
         * @param request
         * @param response
         * @throws ServletException
         * @throws IOException
         */
        public void regist(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
           ......
        }
    
        /**
         * 登录功能
         * @param request
         * @param response
         * @throws ServletException
         * @throws IOException
         */
        public void login(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
           ......
        }
    
        /**
         * 查询单个对象
         * @param request
         * @param response
         * @throws ServletException
         * @throws IOException
         */
        public void findOne(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
           ......
        }
    
        /**
         * 退出功能
         * @param request
         * @param response
         * @throws ServletException
         * @throws IOException
         */
        public void exit(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            ......
        }
    
        /**
         * 激活功能
         * @param request
         * @param response
         * @throws ServletException
         * @throws IOException
         */
        public void active(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            ......
        }
    } 
